---
title: "Lab 2: Spatial Analysis and Visualization"
subtitle: "Healthcare Access and Equity in Pennsylvania"
author: "Chen Yitao"
date: today
format: 
  html:
    code-fold: false
    toc: true
    toc-location: left
    theme: cosmo
    embed-resources: true
execute:
  warning: false
  message: false
---

## Part 1: Healthcare Access for Vulnerable Populations

### Research Question

**Which Pennsylvania counties have the highest proportion of vulnerable populations (elderly + low-income) living far from hospitals?**

Your analysis should identify counties that should be priorities for healthcare investment and policy intervention.

### Required Analysis Steps

Complete the following analysis, documenting each step with code and brief explanations:

#### Step 1: Data Collection (5 points)

Load the required spatial data:
- Pennsylvania county boundaries
- Pennsylvania hospitals (from lecture data)
- Pennsylvania census tracts

**Your Task:**
```{r}
#| message: false
#| warning: false
#| results: 'hide'
# Load required packages
library(sf)
library(tidyverse)
library(tigris)
library(tidycensus)
library(scales)
library(patchwork)
library(here)
census_api_key(Sys.getenv("CENSUS_API_KEY"))
# Load spatial data
pa_counties <- st_read(here("C:/Users/cheny/Desktop/CPLN 5920 Public Policy Analytics/CPLN-5920-SP26-main/CPLN-5920-SP26-main/lectures/week_04/data/Pennsylvania_County_Boundaries.shp"))
hospitals <- st_read(here("C:/Users/cheny/Desktop/CPLN 5920 Public Policy Analytics/CPLN-5920-SP26-main/CPLN-5920-SP26-main/lectures/week_04/data/hospitals.geojson"))
census_tracts <- tracts(state = "PA", cb = TRUE)
# Check that all data loaded correctly
hospitals <- st_transform(hospitals, st_crs(pa_counties))
census_tracts <- st_transform(census_tracts, st_crs(pa_counties))
glimpse(pa_counties)
glimpse(hospitals)
glimpse(census_tracts)
```

**Questions to answer:**
- How many hospitals are in your dataset? Hospitals: 223 
```{r}
cat("Hospitals:", nrow(hospitals), "\n")
```

- How many census tracts? Number of census tracts: 3445 
```{r}
cat("Number of census tracts:", nrow(census_tracts), "\n")
```

- What coordinate reference system is each dataset in? "WGS 84 / Pseudo-Mercator"
```{r}
#| message: false
#| warning: false
#| results: 'hide'
st_crs(pa_counties)
st_crs(hospitals)
st_crs(census_tracts)
```

---

#### Step 2: Get Demographic Data 

Use `tidycensus` to download tract-level demographic data for Pennsylvania.

**Required variables:**
- Total population
- Median household income
- Population 65 years and over (you may need to sum multiple age categories)

**Your Task:**
```{r}
# Get demographic data from ACS
tract_demographics <- get_acs(
  geography = "tract",
  variables = c(
    total_pop = "B01003_001",
    median_income = "B19013_001",
    male_65_66 = "B01001_020",
    male_67_69 = "B01001_021",
    male_70_74 = "B01001_022",
    male_75_79 = "B01001_023",
    male_80_84 = "B01001_024",
    male_85_up = "B01001_025",
    female_65_66 = "B01001_044",
    female_67_69 = "B01001_045",
    female_70_74 = "B01001_046",
    female_75_79 = "B01001_047",
    female_80_84 = "B01001_048",
    female_85_up = "B01001_049"),
  state = "PA",
  year = 2022,
  output = "wide"
)

tract_demographics <- tract_demographics %>%
  mutate(
    over_65E =
      male_65_66E + male_67_69E + male_70_74E + male_75_79E + male_80_84E + male_85_upE +
      female_65_66E + female_67_69E + female_70_74E + female_75_79E + female_80_84E + female_85_upE,
    over_65M = sqrt(
      male_65_66M^2 + male_67_69M^2 + male_70_74M^2 + male_75_79M^2 + male_80_84M^2 + male_85_upM^2 +
      female_65_66M^2 + female_67_69M^2 + female_70_74M^2 + female_75_79M^2 + female_80_84M^2 + female_85_upM^2
    )
 )

tract_demographics_sum <- tract_demographics %>%
  select(
    GEOID,
    total_popE, total_popM,
    median_incomeE, median_incomeM,
    over_65E, over_65M
  )
glimpse(tract_demographics_sum)
# Join to tract boundaries
census_tracts_join <- census_tracts %>%
  left_join(tract_demographics_sum, by = "GEOID")

glimpse(census_tracts_join)

```

**Questions to answer:**
- What year of ACS data are you using? 2022
- How many tracts have missing income data? 62
```{r}
cat(
  "Tracts with missing income data:",
  sum(is.na(census_tracts_join$median_incomeE)),
  "\n"
)
```
- What is the median income across all PA census tracts? 70188	
```{r}
median_income_all <- census_tracts_join %>%
  st_drop_geometry() %>%
  summarize(
    median_income = median(median_incomeE, na.rm = TRUE)
  )
median_income_all
```
---

#### Step 3: Define Vulnerable Populations 

Identify census tracts with vulnerable populations based on TWO criteria:
1. Low median household income (choose an appropriate threshold)
2. Significant elderly population (choose an appropriate threshold)

**Your Task:**
```{r}
# Filter for vulnerable tracts based on your criteria
criteria_tracts <- census_tracts_join %>%
  mutate(pct_over_65 = over_65E / total_popE * 100) %>%
  filter(
    !is.na(median_incomeE),
    !is.na(total_popE),
    total_popE > 0,
    !is.na(over_65E)
  )

state_median_tract_income <- median(criteria_tracts$median_incomeE, na.rm = TRUE)
income_threshold <- 0.8 * state_median_tract_income
elderly_threshold <- 14

vulnerable_tracts <- criteria_tracts %>%
  filter(
    median_incomeE <= income_threshold,
    pct_over_65 >= elderly_threshold
  )

summary_tbl <- criteria_tracts %>%
  st_drop_geometry() %>%
  summarize(
    income_threshold = income_threshold,
    elderly_threshold_pct = elderly_threshold,
    n_total_tracts_used = n(),
    n_vulnerable_tracts = sum(
      median_incomeE <= income_threshold & pct_over_65 >= elderly_threshold,
      na.rm = TRUE
    ),
    pct_vulnerable = n_vulnerable_tracts / n_total_tracts_used * 100
  )

knitr::kable(
  summary_tbl,
  digits = 2,
  caption = "Vulnerability thresholds and results (tracts with non-missing income and valid population only)"
)

```

**Questions to answer:**

- What income threshold did you choose and why?

I define “low income” as census tracts with median household income at or below 80% of the statewide median tract income (ACS 2022). I chose the 80% cutoff because HUD commonly uses ≤80% of Area Median Income as a policy threshold for low-income eligibility in housing programs.

- What elderly population threshold did you choose and why?

I define “high-elderly” tracts as those with a 65+ population share ≥ 14%. This threshold follows WHO’s commonly cited typology, which describes a population as aged when more than 14% of residents are aged 65 and above. Some references also use 21% as the threshold for a super-aged society. For this statewide tract-level analysis, I adopt the 14% threshold to maintain a defensible standard while avoiding an overly restrictive definition.

- How many tracts meet your vulnerability criteria? 

525; 243 (When Threshold=21%)	

- What percentage of PA census tracts are considered vulnerable by your definition? 

15.52%; 7.18%(When Threshold=21%)

---

#### Step 4: Calculate Distance to Hospitals 

For each vulnerable tract, calculate the distance to the nearest hospital.

**Your Task:**
```{r}
# Transform to appropriate projected CRS
vulnerable_tracts_proj <- vulnerable_tracts %>%
  st_transform(5070)
hospitals_proj <- hospitals %>%
  st_transform(5070)

# Calculate distance from each tract centroid to nearest hospital
vulnerable_centroids <- st_centroid(vulnerable_tracts_proj)
distance_matrix <- st_distance(vulnerable_centroids, hospitals_proj)
vulnerable_tracts_proj <- vulnerable_tracts_proj %>%
  mutate(
    nearest_hospital_distance = as.numeric(apply(distance_matrix, 1, min)),
    nearest_hospital_miles = nearest_hospital_distance / 1609.344
  )

distance_summary <- vulnerable_tracts_proj %>%
  st_drop_geometry() %>%
  summarize(
    avg_distance = mean(nearest_hospital_miles, na.rm = TRUE),
    max_distance = max(nearest_hospital_miles, na.rm = TRUE),
    over_15_miles = sum(nearest_hospital_miles > 15, na.rm = TRUE)
  )

knitr::kable(
  distance_summary,
  digits = 2,
  caption = "Distance to nearest hospital for vulnerable tracts"
)
```

**Requirements:**
- Use an appropriate projected coordinate system for Pennsylvania 
- Calculate distances in miles 	
- Explain why you chose your projection 

**Questions to answer:**

- What is the average distance to the nearest hospital for vulnerable tracts? 

4.59

- What is the maximum distance? 

25.65

- How many vulnerable tracts are more than 15 miles from the nearest hospital? 

13

---

#### Step 5: Identify Underserved Areas 

Define "underserved" as vulnerable tracts that are more than 15 miles from the nearest hospital.

**Your Task:**
```{r}
# Create underserved variable
vulnerable_tracts_proj <- vulnerable_tracts_proj %>%
  mutate(
    underserved = nearest_hospital_miles > 15
  )

underserved_summary <- vulnerable_tracts_proj %>%
  st_drop_geometry() %>%
  summarize(
    n_vulnerable_tracts = n(),
    n_underserved = sum(underserved, na.rm = TRUE),
    pct_underserved = n_underserved / n_vulnerable_tracts * 100
  )
knitr::kable(
  underserved_summary,
  digits = 2,
  caption = "Underserved vulnerable tracts"
)

```

**Questions to answer:**

- How many tracts are underserved? 

13

- What percentage of vulnerable tracts are underserved? 

5.35%

- Does this surprise you? Why or why not? 

I got 5.35%, which is somewhat surprising because I expected a higher share. This maybe suggests that most vulnerable tracts are actually within the service distance of hospitals.

---

#### Step 6: Aggregate to County Level

Use spatial joins and aggregation to calculate county-level statistics about vulnerable populations and hospital access.

**Your Task:**
```{r}
# Spatial join tracts to counties
pa_counties_proj <- pa_counties %>%
  st_transform(st_crs(vulnerable_tracts_proj))

vulnerable_with_county <- vulnerable_tracts_proj %>%
  st_join(pa_counties_proj %>% select(COUNTY_NAM))

# Aggregate statistics by county
county_stats <- vulnerable_with_county %>%
  st_drop_geometry() %>%
  group_by(COUNTY_NAM) %>%
  summarize(
    n_vulnerable_tracts = n(),
    n_underserved_tracts = sum(underserved, na.rm = TRUE),
    pct_underserved = n_underserved_tracts / n_vulnerable_tracts * 100,
    avg_distance_miles = mean(nearest_hospital_miles, na.rm = TRUE),
    total_vulnerable_population = sum(total_popE, na.rm = TRUE),
    vulnerable_pop_far_from_hospital = sum(if_else(underserved, total_popE, 0), na.rm = TRUE)
  ) %>%
  arrange(desc(pct_underserved))

knitr::kable(
  county_stats,
  digits = 2,
  caption = "County-level statistics about vulnerable populations and hospital access"
)

```

**Required county-level statistics:**
- Number of vulnerable tracts
- Number of underserved tracts  
- Percentage of vulnerable tracts that are underserved
- Average distance to nearest hospital for vulnerable tracts
- Total vulnerable population

**Questions to answer:**

- Which 5 counties have the highest percentage of underserved vulnerable tracts? 

COLUMBIA, MONROE, PERRY, SULLIVAN,(100%); BRADFORD, CAMERON, CLINTON, DAUPHIN(50%)

- Which counties have the most vulnerable people living far from hospitals? CLEARFIELD
```{r}
county_stats %>%
  arrange(desc(vulnerable_pop_far_from_hospital))
head(county_stats)
```

- Are there any patterns in where underserved counties are located?

Yes, the distribution of underserved counties shows a strong spatial pattern and continuity. They are concentrated in central and northern Pennsylvania, while there are relatively few in the southeastern and southwestern parts of the state. This may indicate that limited healthcare access is more likely to occur in inland counties with lower population density and a more sparse distribution of hospitals.

```{r}
counties_with_stats <- pa_counties_proj %>%
  left_join(county_stats, by = "COUNTY_NAM")
ggplot(counties_with_stats) +
  geom_sf(aes(fill = pct_underserved), color = "white", size = 0.2) +
  scale_fill_viridis_c(
    name = "% Underserved",
    option = "inferno",
    na.value = "gray"
  ) +
  labs(
    title = "Percent of Underserved Vulnerable Tracts by County",
    subtitle = "Gray counties have no vulnerable tract data"
  ) +
  theme_void()

```
---

#### Step 7: Create Summary Table 

Create a professional table showing the top 10 priority counties for healthcare investment.

**Your Task:**
```{r}
# Create and format priority counties table
priority_counties <- county_stats %>%
  arrange(
    desc(vulnerable_pop_far_from_hospital),
    desc(pct_underserved),
    desc(avg_distance_miles)
  ) %>%
  select(
    COUNTY_NAM,
    n_vulnerable_tracts,
    n_underserved_tracts,
    pct_underserved,
    avg_distance_miles,
    total_vulnerable_population,
    vulnerable_pop_far_from_hospital
  ) %>%
  head(10) %>%
  rename(
    County = COUNTY_NAM,
    `Vulnerable Tracts` = n_vulnerable_tracts,
    `Underserved Tracts` = n_underserved_tracts,
    `Underserved Percentage` = pct_underserved,
    `Avg Distance (miles)` = avg_distance_miles,
    `Total Vulnerable Population` = total_vulnerable_population,
    `Vulnerable Population Far from Hospital` = vulnerable_pop_far_from_hospital
  ) %>%
  mutate(
    `Underserved Percentage` = sprintf("%.1f%%", `Underserved Percentage`),
    `Avg Distance (miles)` = sprintf("%.2f", `Avg Distance (miles)`),
    `Total Vulnerable Population` = scales::comma(`Total Vulnerable Population`),
    `Vulnerable Population Far from Hospital` = scales::comma(`Vulnerable Population Far from Hospital`)
  )

knitr::kable(
  priority_counties,
  caption = "Top 10 priority counties for healthcare investment (ranked by vulnerable population living far from hospital)"
)

```

**Requirements:**
- Use `knitr::kable()` or similar for formatting
- Include descriptive column names
- Format numbers appropriately (commas for population, percentages, etc.)
- Add an informative caption
- Sort by priority (you decide the metric)

---

## Part 2: Comprehensive Visualization 

Using the skills from Week 3 (Data Visualization), create publication-quality maps and charts.

### Map 1: County-Level Choropleth 

Create a choropleth map showing healthcare access challenges at the county level.

**Your Task:**
```{r}
# Create county-level access map
counties_with_stats <- pa_counties_proj %>%
  left_join(county_stats, by = "COUNTY_NAM")

counties_with_stats <- pa_counties_proj %>%
  left_join(county_stats, by = "COUNTY_NAM")

ggplot(counties_with_stats) +
  geom_sf(aes(fill = pct_underserved), color = "white", size = 0.2) +
  geom_sf(data = hospitals, color = "deepskyblue", size = 0.6, alpha = 0.8) +
  scale_fill_viridis_c(
    name = "% Underserved",
    option = "magma",
    na.value = "gray80",
    limits = c(0, 100),
    labels = function(x) paste0(x, "%")
  ) +
  labs(
    title = "Percent of Underserved Vulnerable Tracts by County",
    subtitle = "Hospital locations are shown as points; Gray counties have no vulnerable tract data",
    caption = "Sources: Pennsylvania county boundaries and hospital locations; ACS 2022 tract data via tidycensus"
  ) +
  theme_void()

```

**Requirements:**
- Fill counties by percentage of vulnerable tracts that are underserved
- Include hospital locations as points
- Use an appropriate color scheme
- Include clear title, subtitle, and caption
- Use `theme_void()` or similar clean theme
- Add a legend with formatted labels

---

### Map 2: Detailed Vulnerability Map 

Create a map highlighting underserved vulnerable tracts.

**Your Task:**
```{r}
# Create detailed tract-level map
pa_counties_map2 <- pa_counties %>%
  st_transform(st_crs(vulnerable_tracts_proj))

hospitals_map2 <- hospitals %>%
  st_transform(st_crs(vulnerable_tracts_proj))

ggplot() +
  geom_sf(
    data = vulnerable_tracts_proj,
    fill = "deepskyblue4",
    color = "white",
    size = 0.02,
    alpha = 0.45
  ) +
  geom_sf(
    data = vulnerable_tracts_proj %>%
      filter(underserved),
    fill = "red",
    color = "white",
    size = 0.05,
    alpha = 0.85
  ) +
  geom_sf(
    data = pa_counties_map2,
    fill = NA,
    color = "gray",
    size = 0.25
  ) +
  geom_sf(
    data = hospitals_map2,
    color = "orange",
    size = 0.5,
    alpha = 0.9
  ) +
  labs(
    title = "Underserved Vulnerable Census Tracts in Pennsylvania",
    subtitle = "Red tracts are underserved vulnerable tracts; blue tracts are other vulnerable tracts; points are hospitals",
    caption = "Sources: Pennsylvania county boundaries and hospitals; ACS 2022 tract demographics via tidycensus"
  ) +
  theme_void()

```

**Requirements:**
- Show underserved vulnerable tracts in a contrasting color
- Include county boundaries for context
- Show hospital locations
- Use appropriate visual hierarchy (what should stand out?)
- Include informative title and subtitle

---

### Chart: Distribution Analysis

Create a visualization showing the distribution of distances to hospitals for vulnerable populations.

**Your Task:**
```{r}
# Create distribution visualization
distance_chart <- vulnerable_tracts_proj %>%
  st_drop_geometry()

ggplot(distance_chart, aes(x = nearest_hospital_miles)) +
  geom_histogram(
    binwidth = 2,
    fill = "lightblue",
    color = "white"
  ) +
  labs(
    title = "Distribution of Distance to Nearest Hospital for Vulnerable Populations",
    subtitle = "Pennsylvania vulnerable census tracts",
    x = "Distance to nearest hospital (miles)",
    y = "Number of vulnerable tracts",
    caption = "Source: ACS 2022 and lecture hospital dataset"
)

```

**Suggested chart types:**
- Histogram or density plot of distances
- Box plot comparing distances across regions
- Bar chart of underserved tracts by county
- Scatter plot of distance vs. vulnerable population size

**Requirements:**
- Clear axes labels with units
- Appropriate title
- Professional formatting
- Brief interpretation (1-2 sentences as a caption or in text)
The distribution is concentrated at shorter distances, with most vulnerable census tracts located within 0–5 miles of the nearest hospital. Only a small number of tracts are located more than 20 miles away.

---

## Part 3: Bring Your Own Data Analysis 

Choose your own additional spatial dataset and conduct a supplementary analysis.

### Challenge Options

Choose ONE of the following challenge exercises, or propose your own research question using OpenDataPhilly data (https://opendataphilly.org/datasets/). 

**Note these are just loose suggestions to spark ideas - follow or make your own as the data permits and as your ideas evolve. This analysis should include bringing in your own dataset, ensuring the projection/CRS of your layers align and are appropriate for the analysis (not lat/long or geodetic coordinate systems). The analysis portion should include some combination of spatial and attribute operations to answer a relatively straightforward question**

---

#### Education & Youth Services

**Option A: Educational Desert Analysis**
- **Data:** Schools, Libraries, Recreation Centers, Census tracts (child population)
- **Question:** "Which neighborhoods lack adequate educational infrastructure for children?"
- **Operations:** Buffer schools/libraries (0.5 mile walking distance), identify coverage gaps, overlay with child population density
- **Policy relevance:** School district planning, library placement, after-school program siting

**Option B: School Safety Zones**
- **Data:** Schools, Crime Incidents, Bike Network
- **Question:** "Are school zones safe for walking/biking, or are they crime hotspots?"
- **Operations:** Buffer schools (1000ft safety zone), spatial join with crime incidents, assess bike infrastructure coverage
- **Policy relevance:** Safe Routes to School programs, crossing guard placement

---

#### Environmental Justice

**Option C: Green Space Equity** 
- **Data:** Parks, Street Trees, Census tracts (race/income demographics)
- **Question:** "Do low-income and minority neighborhoods have equitable access to green space?"
- **Operations:** Buffer parks (10-minute walk = 0.5 mile), calculate tree canopy or park acreage per capita, compare by demographics
- **Policy relevance:** Climate resilience, environmental justice, urban forestry investment
---

#### Public Safety & Justice

**Option D: Crime & Community Resources**
- **Data:** Crime Incidents, Recreation Centers, Libraries, Street Lights
- **Question:** "Are high-crime areas underserved by community resources?"
- **Operations:** Aggregate crime counts to census tracts or neighborhoods, count community resources per area, spatial correlation analysis
- **Policy relevance:** Community investment, violence prevention strategies
---

#### Infrastructure & Services

**Option E: Polling Place Accessibility**
- **Data:** Polling Places, SEPTA stops, Census tracts (elderly population, disability rates)
- **Question:** "Are polling places accessible for elderly and disabled voters?"
- **Operations:** Buffer polling places and transit stops, identify vulnerable populations, find areas lacking access
- **Policy relevance:** Voting rights, election infrastructure, ADA compliance

---

#### Health & Wellness

**Option F: Recreation & Population Health**
- **Data:** Recreation Centers, Playgrounds, Parks, Census tracts (demographics)
- **Question:** "Is lack of recreation access associated with vulnerable populations?"
- **Operations:** Calculate recreation facilities per capita by neighborhood, buffer facilities for walking access, overlay with demographic indicators
- **Policy relevance:** Public health investment, recreation programming, obesity prevention

---

#### Emergency Services

**Option G: EMS Response Coverage**
- **Data:** Fire Stations, EMS stations, Population density, High-rise buildings
- **Question:** "Are population-dense areas adequately covered by emergency services?"
- **Operations:** Create service area buffers (5-minute drive = ~2 miles), assess population coverage, identify gaps in high-density areas
- **Policy relevance:** Emergency preparedness, station siting decisions

---

#### Arts & Culture

**Option H: Cultural Asset Distribution**
- **Data:** Public Art, Museums, Historic sites/markers, Neighborhoods
- **Question:** "Do all neighborhoods have equitable access to cultural amenities?"
- **Operations:** Count cultural assets per neighborhood, normalize by population, compare distribution across demographic groups
- **Policy relevance:** Cultural equity, tourism, quality of life, neighborhood identity

---

### Data Sources

**OpenDataPhilly:** https://opendataphilly.org/datasets/
- Most datasets available as GeoJSON, Shapefile, or CSV with coordinates
- Always check the Metadata for a data dictionary of the fields.

**Additional Sources:**
- **Pennsylvania Open Data:** https://data.pa.gov/
- **Census Bureau (via tidycensus):** Demographics, economic indicators, commute patterns
- **TIGER/Line (via tigris):** Geographic boundaries

### Recommended Starting Points

**If you're feeling confident:** Choose an advanced challenge with multiple data layers. 
**If you are a beginner, choose something more manageable that helps you understand the basics**


**If you have a different idea:** Propose your own question! Just make sure:
- You can access the spatial data
- You can perform at least 2 spatial operations

### Your Analysis

**Your Task:**

1. **Find and load additional data**
   - Document your data source
   - Check and standardize the CRS
   - Provide basic summary statistics

```{r}
#| message: false
#| warning: false
#| results: 'hide'
# Load your additional dataset
parks <- st_read("C:/Users/cheny/Desktop/CPLN 5920 Public Policy Analytics/cpln-5920-sp26-student-portfolio-template/data/PPR_Properties/PPR_Properties.shp", quiet = TRUE)
census_tracts <- tracts(state = "PA", county = "Philadelphia", cb = TRUE)

nrow(parks)
nrow(census_tracts)

st_crs(parks)
st_crs(census_tracts)

parks <- st_transform(parks, 2272)
census_tracts <- st_transform(census_tracts, 2272)

st_crs(parks)
st_crs(census_tracts)

```

**Questions to answer:**

- What dataset did you choose and why? 

I selected three spatial datasets. I used PPR Properties as the parks layer, and Census tracts as the study area and the base unit for the later analysis. This combination fits my Green Space Equity topic because I need park locations, and tract boundaries to compare conditions across different areas.

- What is the data source and date?

The data sources are OpenDataPhilly and the U.S. Census, with Census tract boundaries obtained through the tigris package in R. I downloaded the shapefiles for PPR Properties from OpenDataPhilly. The PPR Properties dataset was last updated on April 8, 2025. The Census tract boundaries were downloaded directly in R, and the data year is 2024.

- How many features does it contain?

PPR Properties (Parks): 504

Census tracts: 408

- What CRS is it in? Did you need to transform it?

Before transformation, the three datasets were in different coordinate reference systems. PPR Properties was in WGS 84 / Pseudo-Mercator (EPSG:3857), while Census tracts were in NAD83 (EPSG:4269). 
Because the layers did not share the same CRS, I transformed all three datasets to EPSG:2272 (NAD83 / Pennsylvania South, ftUS) so they use one common projected coordinate system for the later buffer and spatial analysis.

---

2. **Pose a research question**

Do low-income and minority census tracts in Philadelphia have equitable access to green space?

**Examples:**
- "Do vulnerable tracts have adequate public transit access to hospitals?"
- "Are EMS stations appropriately located near vulnerable populations?"
- "Do areas with low vehicle access have worse hospital access?"

---

3. **Conduct spatial analysis**

Use at least TWO spatial operations to answer your research question.

**Required operations (choose 2+):**
- Buffers
- Spatial joins
- Spatial filtering with predicates
- Distance calculations
- Intersections or unions
- Point-in-polygon aggregation

**Your Task:**
```{r}
# Your spatial analysis
# Get ACS tract demographic data
acs_data <- get_acs(
  geography = "tract",
  state = "PA",
  county = "Philadelphia",
  year = 2023,
  survey = "acs5",
  variables = c(
    total_pop = "B01003_001",
    med_hh_income = "B19013_001",
    race_total = "B03002_001",
    white_nonhisp = "B03002_003"
  ),
  output = "wide",
  geometry = FALSE
)
# Keep the main estimate columns and rename them
acs_data_clean <- acs_data %>%
  transmute(
    GEOID,
    total_pop = total_popE,
    med_hh_income = med_hh_incomeE,
    race_total = race_totalE,
    white_nonhisp = white_nonhispE
  )
# Join ACS attributes to tract geometry
tracts_analysis <- census_tracts %>%
  left_join(acs_data_clean, by = "GEOID") %>%
  mutate(
    pct_nonwhite = if_else(
      !is.na(race_total) & race_total > 0,
      100 * (race_total - white_nonhisp) / race_total,
      NA_real_
    )
  )
# Check
nrow(tracts_analysis)
names(tracts_analysis)

# Fix invalid geometries (By GPT)
parks_poly <- parks[st_geometry_type(parks) %in% c("POLYGON", "MULTIPOLYGON"), ]
parks_poly <- st_make_valid(parks_poly)
tracts_analysis <- st_make_valid(tracts_analysis)
parks_poly <- st_collection_extract(parks_poly, "POLYGON")
tracts_analysis <- st_collection_extract(tracts_analysis, "POLYGON")
parks_poly <- parks_poly[!st_is_empty(parks_poly), ]
tracts_analysis <- tracts_analysis[!st_is_empty(tracts_analysis), ]
parks_poly <- st_set_precision(parks_poly, 1)
tracts_analysis <- st_set_precision(tracts_analysis, 1)
parks_poly <- st_buffer(parks_poly, 0)
tracts_analysis <- st_buffer(tracts_analysis, 0)
sum(!st_is_valid(parks_poly))
sum(!st_is_valid(tracts_analysis))
tracts_union <- st_union(tracts_analysis)
# Clip parks to city boundary first
parks_poly_clip <- st_intersection(parks_poly, tracts_union)
# Then intersect clipped parks with tracts
park_in_tract <- st_intersection(
  parks_poly_clip,
  tracts_analysis %>% select(GEOID)
)

# Create 0.5-mile buffers around parks
buffer_dist_ft <- 2640
park_buffers <- st_buffer(parks, dist = buffer_dist_ft)
# Dissolve overlapping buffers
park_buffer_union <- st_union(park_buffers)
# Intersect tract polygons with the park buffers
tract_buffer_cover <- st_intersection(
  tracts_analysis %>% select(GEOID),
  park_buffer_union
)
# Calculate covered area within each tract
buffer_cover_by_tract <- tract_buffer_cover %>%
  mutate(buffer_cover_acres = as.numeric(st_area(geometry)) / 43560) %>%
  st_drop_geometry() %>%
  group_by(GEOID) %>%
  summarise(buffer_cover_acres = sum(buffer_cover_acres, na.rm = TRUE), .groups = "drop")
# Calculate total tract area
tracts_analysis <- tracts_analysis %>%
  mutate(tract_acres = as.numeric(st_area(geometry)) / 43560)
# Calculate park access percent
tracts_analysis <- tracts_analysis %>%
  left_join(buffer_cover_by_tract, by = "GEOID") %>%
  mutate(
    buffer_cover_acres = dplyr::coalesce(buffer_cover_acres, 0),
    park_access_pct = if_else(tract_acres > 0, 100 * buffer_cover_acres / tract_acres, NA_real_)
  )

# Tract-level park 10-minute access table
park_access_table <- tracts_analysis %>%
  st_drop_geometry() %>%
  select(GEOID, NAME, med_hh_income, pct_nonwhite, park_access_pct) %>%
  mutate(
    med_hh_income = round(med_hh_income, 0),
    pct_nonwhite = round(pct_nonwhite, 1),
    park_access_pct = round(park_access_pct, 1)
  ) %>%
  arrange(park_access_pct)

park_access_table %>%
  knitr::kable(
    caption = "Park Walking Access Census Tracts in Philadelphia (10-minute walk park buffer)",
    col.names = c("GEOID", "Tract", "Median HH Income", "% Non-White", "Park Access %")
  )

# Intersect park polygons with census tracts
park_in_tract <- st_intersection(
  parks_poly,
  tracts_analysis %>% select(GEOID)
)
# Calculate park area for each intersected piece
park_area_by_tract <- park_in_tract %>%
  mutate(park_acres = as.numeric(st_area(geometry)) / 43560) %>%
  st_drop_geometry() %>%
  group_by(GEOID) %>%
  summarise(park_acres = sum(park_acres, na.rm = TRUE), .groups = "drop")
# Join park area to tract data
tracts_analysis <- tracts_analysis %>%
  select(-any_of(c("park_acres", "park_acres_per_1000"))) %>%
  left_join(park_area_by_tract, by = "GEOID") %>%
  mutate(
    park_acres = dplyr::coalesce(park_acres, 0),
    park_acres_per_1000 = if_else(
      !is.na(total_pop) & total_pop > 0,
      1000 * park_acres / total_pop,
      NA_real_
    )
  )
# Tract-level park acreage per 1,000 residents table
park_acres_table <- tracts_analysis %>%
  st_drop_geometry() %>%
  select(GEOID, NAME, med_hh_income, pct_nonwhite, park_acres, park_acres_per_1000) %>%
  mutate(
    med_hh_income = round(med_hh_income, 0),
    pct_nonwhite = round(pct_nonwhite, 1),
    park_acres = round(park_acres, 2),
    park_acres_per_1000 = round(park_acres_per_1000, 2)
  ) %>%
  arrange(park_acres_per_1000)

park_acres_table %>%
  knitr::kable(
    caption = "Park Acreage per 1,000 Residents by Census Tract in Philadelphia",
    col.names = c("GEOID", "Tract", "Median HH Income", "% Non-White", "Park Acres", "Park Acres per 1,000")
  )

# Green Acess for vulnerable tracts
income_shredhold <- quantile(tracts_analysis$med_hh_income, probs = 0.25, na.rm = TRUE)
race_shredhold <- quantile(tracts_analysis$pct_nonwhite, probs = 0.75, na.rm = TRUE)

tracts_analysis <- tracts_analysis %>%
  mutate(
    low_income = if_else(med_hh_income < income_shredhold, TRUE, FALSE),
    high_nonwhite = if_else(pct_nonwhite > race_shredhold, TRUE, FALSE),
    vulnerable = low_income & high_nonwhite
  )
vulnerable_tracts <- tracts_analysis %>%
  filter(vulnerable)
vulnerable_tracts %>%
  st_drop_geometry() %>%
  select(GEOID, NAME, med_hh_income, pct_nonwhite, park_access_pct, park_acres_per_1000) %>%
  mutate(
    med_hh_income = round(med_hh_income, 0),
    pct_nonwhite = round(pct_nonwhite, 1),
    park_access_pct = round(park_access_pct, 1),
    park_acres_per_1000 = round(park_acres_per_1000, 2)
  ) %>%
  arrange(park_access_pct, park_acres_per_1000) %>%
  knitr::kable(
    caption = "Vulnerable Census Tracts and Their Green Space Indicators",
    col.names = c("GEOID", "Tract", "Median HH Income", "% Non-White", "Park Access %", "Park Acres per 1,000")
  )

# Green Space Walking Access in Vulnerable Census Tracts
ggplot() +
  geom_sf(data = tracts_analysis, fill = "grey95", color = "white", linewidth = 0.15) +
  geom_sf(data = tracts_analysis %>% filter(vulnerable),
          aes(fill = park_access_pct), color = "grey20", linewidth = 0.2) +
  scale_fill_viridis_c(option = "rocket", na.value = "grey80") +
  labs(
    title = "Green Space Walking Access in Vulnerable Census Tracts",
    subtitle = "Vulnerable = low-income and high non-white",
    fill = "Park Access %"
  ) +
  theme_minimal()

# Park Acreage per 1,000 Residents in Vulnerable Census Tracts
ggplot() +
  geom_sf(data = tracts_analysis %>% filter(!vulnerable),fill = "grey95",color = "white",linewidth = 0.15) +
  geom_sf(data = tracts_analysis %>% filter(vulnerable),aes(fill = park_acres_per_1000),color = "grey80",linewidth = 0.2) +
  scale_fill_viridis_c(option = "plasma",na.value = "grey80") +
  labs(
    title = "Park Acreage per 1,000 Residents in Vulnerable Census Tracts",
    subtitle = "Vulnerable = low-income and high non-white",
    fill = "Acres / 1,000"
  ) +
  theme_minimal()

# Park Walking Access Vulnerable Census Tracts vs Non-vulnerable Census Tracts
income_q25 <- unname(quantile(tracts_analysis$med_hh_income, 0.25, na.rm = TRUE))
access_median <- median(tracts_analysis$park_access_pct, na.rm = TRUE)

tracts_analysis <- tracts_analysis %>%
  mutate(
    low_income = !is.na(med_hh_income) & med_hh_income < income_q25,
    high_nonwhite_75 = !is.na(pct_nonwhite) & pct_nonwhite > 75,
    vulnerable = low_income & high_nonwhite_75
  )

plot_df <- tracts_analysis %>%
  st_drop_geometry() %>%
  mutate(
    vuln_label = if_else(
      vulnerable,
      "Vulnerable tract",
      "Non-vulnerable tract",
      missing = "Non-vulnerable tract"
    )
  ) %>%
  filter(!is.na(park_access_pct), !is.na(med_hh_income))

ggplot(plot_df, aes(x = park_access_pct, y = med_hh_income)) +
  geom_point(aes(shape = vuln_label), alpha = 0.7, size = 2) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.8) +
  geom_hline(yintercept = income_q25, linetype = "dashed", linewidth = 0.5) +
  geom_vline(xintercept = access_median, linetype = "dashed", linewidth = 0.5) +
  labs(
    title = "Park Walking Access Vulnerable vs Non-vulnerable",
    subtitle = "Vulnerable = low-income AND >75% non-white",
    x = "Park Access (%)",
    y = "Median Household Income (ACS)",
    shape = "Tract Type"
  ) +
  theme_minimal()

# Park Acreage per 1,000 Residents Vulnerable Census Tracts vs Non-vulnerable Census Tracts
income_q25 <- unname(quantile(tracts_analysis$med_hh_income, 0.25, na.rm = TRUE))
tracts_analysis <- tracts_analysis %>%
  mutate(
    low_income = !is.na(med_hh_income) & med_hh_income < income_q25,
    high_nonwhite_75 = !is.na(pct_nonwhite) & pct_nonwhite > 75,
    vulnerable = low_income & high_nonwhite_75
  )
plot_df2 <- tracts_analysis %>%
  st_drop_geometry() %>%
  mutate(
    vuln_label = if_else(
      vulnerable,
      "Vulnerable tract",
      "Non-vulnerable tract",
      missing = "Non-vulnerable tract"
    )
  ) %>%
  filter(!is.na(park_acres_per_1000), !is.na(med_hh_income))

x_p98 <- quantile(plot_df2$park_acres_per_1000, 0.98, na.rm = TRUE)

plot_df2_trim <- plot_df2 %>%
  filter(park_acres_per_1000 <= x_p98)

ggplot(plot_df2_trim, aes(x = park_acres_per_1000, y = med_hh_income)) +
  geom_point(aes(shape = vuln_label), alpha = 0.7, size = 2) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.8) +
  labs(
    title = "Park Acreage per 1,000 Residents Vulnerable vs Non-vulnerable",
    subtitle = "Vulnerable = low-income AND >75% non-white; top 2% park acreage values removed for readability",
    x = "Park Acres per 1,000 Residents",
    y = "Median Household Income (ACS)",
    shape = "Tract Type"
  ) +
  theme_minimal()

```

**Analysis requirements:**
- Clear code comments explaining each step
- Appropriate CRS transformations
- Summary statistics or counts
- At least one map showing your findings
- Brief interpretation of results (3-5 sentences)

**Your interpretation:**

In this study, census tracts were defined as vulnerable if they were in the lowest 25% of citywide household income and had a non-white population share above 75%. Green space conditions were measured by park walking access and park acreage per 1,000 residents. The results show that, at the tract level, the differences between vulnerable and non-vulnerable tracts are not obvious for these two indicators. Park access in vulnerable tracts is still generally high, and almost all values are above 75%. Park acreage per 1,000 residents is mostly in a lower range, around 0 to 10 acres, and it does not show a clear or stable separation from non-vulnerable tracts. Even after adjusting the vulnerability definition or the green space thresholds, the overall conclusion did not change much. However, this study only focuses on Philadelphia. This result may be related to the city’s stronger attention to green space equity, so it should not be treated as a general conclusion.

## Finally - A few comments about your incorporation of feedback!

Based on the feedback from the previous assignment, I reduced my use of head() and print(), and used kable() instead when showing tables. I also hid some unnecessary outputs so the document is cleaner. Compared with last time, I ran into more errors and technical issues during the spatial analysis, and I asked GPT for help. However, I tried to understand and revise the AI-generated code myself, and I hope the final results are correct.

---

## Submission Requirements

**What to submit:**

1. **Rendered HTML document posted to your course portfolio** with all code, outputs, maps, and text
   - Use `embed-resources: true` in YAML so it's a single file
   - All code should run without errors
   - All maps and charts should display correctly
2. Submit the correct and working links of your assignment on Canvas

---

